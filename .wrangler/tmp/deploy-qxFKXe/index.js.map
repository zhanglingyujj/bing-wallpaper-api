{
  "version": 3,
  "sources": ["../../../src/index.js"],
  "sourceRoot": "C:\\Users\\zhang\\Desktop\\\u6587\u672C\u6587\u4EF6\\bing\\.wrangler\\tmp\\deploy-qxFKXe",
  "sourcesContent": ["export default {\n  async fetch(request, env, ctx) {\n    const url = new URL(request.url);\n    const path = url.pathname;\n\n    // CORS headers\n    const corsHeaders = {\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'GET,HEAD,OPTIONS',\n      'Access-Control-Max-Age': '86400',\n    };\n\n    if (request.method === 'OPTIONS') {\n      return new Response(null, { headers: corsHeaders });\n    }\n\n    try {\n      if (path === '/' || path === '/latest') {\n        // Redirect to today's image URL\n        const data = await getBingDaily(env);\n        return Response.redirect('https://www.bing.com' + data.url, 302);\n      } \n      \n      else if (path === '/api/today') {\n        // Return today's metadata\n        const data = await getBingDaily(env);\n        return new Response(JSON.stringify(data), {\n          headers: { 'Content-Type': 'application/json', ...corsHeaders },\n        });\n      }\n      \n      else if (path === '/random') {\n        // Redirect to a random image URL\n        const image = await env.DB.prepare('SELECT url FROM wallpapers ORDER BY RANDOM() LIMIT 1').first();\n        if (image) {\n          return Response.redirect('https://www.bing.com' + image.url, 302);\n        } else {\n            // Fallback if DB is empty\n            return Response.redirect('https://www.bing.com', 302); \n        }\n      }\n\n      else if (path === '/api/random') {\n        // Return random image metadata\n        const image = await env.DB.prepare('SELECT * FROM wallpapers ORDER BY RANDOM() LIMIT 1').first();\n        if (image) {\n             // Parse the stored JSON string back to object if needed, or just return the row\n             // The row has 'json' column which is the raw bing response\n             try {\n                image.details = JSON.parse(image.json);\n             } catch(e) {}\n             return new Response(JSON.stringify(image), {\n                headers: { 'Content-Type': 'application/json', ...corsHeaders },\n             });\n        }\n        return new Response(JSON.stringify({ error: 'Database empty' }), { status: 404, headers: corsHeaders });\n      }\n\n      else if (path === '/api/archive' || path === '/list') {\n        // List archived images\n        // Optional pagination: ?page=1&limit=10\n        const page = parseInt(url.searchParams.get('page')) || 1;\n        const limit = parseInt(url.searchParams.get('limit')) || 10;\n        const offset = (page - 1) * limit;\n\n        const { results } = await env.DB.prepare('SELECT * FROM wallpapers ORDER BY date DESC LIMIT ? OFFSET ?')\n          .bind(limit, offset)\n          .all();\n        \n        return new Response(JSON.stringify(results), {\n            headers: { 'Content-Type': 'application/json', ...corsHeaders },\n        });\n      }\n\n      return new Response('Not Found', { status: 404 });\n\n    } catch (e) {\n      return new Response('Error: ' + e.message, { status: 500 });\n    }\n  },\n\n  async scheduled(event, env, ctx) {\n    ctx.waitUntil(updateDailyWallpaper(env));\n  }\n};\n\nasync function getBingDaily(env) {\n    // Helper to get today's data. \n    // Logic: Try to fetch from DB first (if we ran the scheduled task), otherwise fetch from Bing API.\n    // However, since scheduled task runs periodically, for real-time /today request, \n    // we might want to fetch live from Bing to ensure it's fresh, then save to DB.\n    \n    // Strategy: Fetch live from Bing, save/update DB, return data.\n    return await updateDailyWallpaper(env);\n}\n\nasync function updateDailyWallpaper(env) {\n    const bingUrl = 'https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=en-US';\n    const response = await fetch(bingUrl);\n    const data = await response.json();\n    \n    if (data.images && data.images.length > 0) {\n        const image = data.images[0];\n        const date = image.startdate;\n        const title = image.title; // Note: 'title' field availability depends on mkt and response format, sometimes it's copyright\n        const copyright = image.copyright;\n        const url = image.url;\n        const jsonStr = JSON.stringify(image);\n\n        // Insert or Ignore into D1\n        // We use INSERT OR REPLACE or INSERT OR IGNORE. REPLACE updates if exists.\n        await env.DB.prepare(\n            `INSERT OR REPLACE INTO wallpapers (date, title, copyright, url, json) VALUES (?, ?, ?, ?, ?)`\n        ).bind(date, title, copyright, url, jsonStr).run();\n\n        return {\n            date,\n            title,\n            copyright,\n            url,\n            raw: image\n        };\n    }\n    throw new Error('Failed to fetch from Bing');\n}\n"],
  "mappings": "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",
  "names": []
}
